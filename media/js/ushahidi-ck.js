/**
 * Copyright (c) 2008-2012 by Ushahidi Dev Team
 * Published under the LGPL license. See License.txt for the
 * full text of the license
 *
 * @requires media/js/OpenLayers.js
 */(function(){window.Ushahidi={proj_4326:new OpenLayers.Projection("EPSG:4326"),proj_900913:new OpenLayers.Projection("EPSG:900913"),markerOpacity:.9,markerRadius:5,markerStrokeWidth:2,markerStrokeOpacity:.9,GEOJSON:"GeoJSON",KML:"KML",DEFAULT:"default",graphicWidth:21,graphicHeight:25,baseURL:"",GeoJSONStyle:function(){var e=new OpenLayers.Style({externalGraphic:"${icon}",graphicTitle:"${cluster_count}",graphicHeight:Ushahidi.graphicHeight,graphicWidth:Ushahidi.graphicWidth,pointRadius:"${radius}",fillColor:"${color}",fillOpacity:"${opacity}",strokeColor:"${strokeColor}",strokeWidth:"${strokeWidth}",strokeOpacity:"${strokeOpacity}",label:"${clusterCount}",fontWeight:"${fontweight}",fontColor:"#ffffff",fontSize:"${fontsize}"},{context:{count:function(e){return e.attributes.count<2?2*Ushahidi.markerRadius:e.attributes.count==2?(Math.min(e.attributes.count,7)+1)*Ushahidi.markerRadius*.8:(Math.min(e.attributes.count,7)+1)*Ushahidi.markerRadius*.6},fontsize:function(e){feature_icon=e.attributes.icon;if(feature_icon!=="")return"9px";feature_count=e.attributes.count;return feature_count>1e3?"20px":feature_count>500?"18px":feature_count>100?"14px":feature_count>10?"12px":feature_count>=2?"10px":""},fontweight:function(e){feature_icon=e.attributes.icon;return feature_icon!==""?"normal":"bold"},radius:function(e){if(e.attributes.radius!=undefined&&e.attributes.radius!="")return e.attributes.radius;feature_count=e.attributes.count;return feature_count>1e4?Ushahidi.markerRadius*17:feature_count>5e3?Ushahidi.markerRadius*10:feature_count>1e3?Ushahidi.markerRadius*8:feature_count>500?Ushahidi.markerRadius*7:feature_count>100?Ushahidi.markerRadius*6:feature_count>10?Ushahidi.markerRadius*5:feature_count>=2?Ushahidi.markerRadius*3:Ushahidi.markerRadius*2},strokeWidth:function(e){if(e.attributes.strokewidth!==undefined&&e.attributes.strokewidth!="")return e.attributes.strokewidth;feature_count=e.attributes.count;return feature_count>1e4?45:feature_count>5e3?30:feature_count>1e3?22:feature_count>100?15:feature_count>10?10:feature_count>=2?5:1},color:function(e){return"#"+e.attributes.color},strokeColor:function(e){return e.attributes.strokecolor!==undefined&&e.attributes.strokecolor!=""?"#"+e.attributes.strokecolor:"#"+e.attributes.color},icon:function(e){feature_icon=e.attributes.icon;return feature_icon!==""?feature_icon:""},clusterCount:function(e){return e.attributes.count>1?$.browser.msie&&$.browser.version=="6.0"?"":e.attributes.count:""},opacity:function(e){feature_icon=e.attributes.icon;return e.attributes.opacity!==undefined&&e.attributes.opacity!=""?e.attributes.opacity:feature_icon!==""?"1":Ushahidi.markerOpacity},strokeOpacity:function(e){return e.attributes.strokeopacity!==undefined&&e.attributes.strokeopacity!=""?e.attributes.strokeopacity:Ushahidi.markerStrokeOpacity},labelalign:function(e){return"c"}}});return e}};Ushahidi.Map=function(e,t){this._registry=[];this._isLoaded=0;this._EVENTS=["filterschanged","zoomchanged","resize","deletelayer","markerpositionchanged","baselayerchanged","mapcenterchanged"];this._reportFilters={};this._callbacks={};this._currentMarkerPosition={};this._selectOnHover=!1;this._popupRegistry={};if(e==undefined)throw"The element or id of an element that will contain the map must be specified";var t=t||{};t.zoom==undefined&&(t.zoom=8);this.currentZoom=t.zoom;this._reportFilters.z=t.zoom;t.center==undefined&&(t.center={latitude:-1.286449478924,longitude:36.822838050049});var n={units:"dd",numZoomLevels:19,theme:!1,controls:[],projection:Ushahidi.proj_900913,displayProjection:Ushahidi.proj_4326,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),maxResolution:156543.0339};t.redrawOnZoom!==undefined&&t.redrawOnZoom&&(n.eventListeners={zoomend:this.refresh,scope:this});if((t.redrawOnZoom==undefined||!t.redrawOnZoom)&&t.detectMapZoom){this.register("zoomchanged",this.updateZoom,this);n.eventListeners={zoomend:this.triggerZoomChanged,scope:this}}t.mapControls==undefined?n.controls=[new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar,new OpenLayers.Control.Attribution,new OpenLayers.Control.MousePosition,new OpenLayers.Control.LayerSwitcher]:n.controls=t.mapControls;this._olMap=new OpenLayers.Map(e,n);t.baseLayers!=undefined&&t.baseLayers.length>0&&this._olMap.addLayers(t.baseLayers);var r=new OpenLayers.LonLat(t.center.longitude,t.center.latitude);r.transform(Ushahidi.proj_4326,Ushahidi.proj_900913);this._currentCenter=r;this._olMap.setCenter(r,t.zoom);t.displayProjection!=undefined&&t.displayProjection&&(document.getElementById("mapProjection").innerHTML=this._olMap.projection);Ushahidi._currentMap=this;this.register("resize",this.resize,this);this.register("deletelayer",this.deleteLayer,this);this.register("baselayerchanged",this.updateBaseLayer,this);this.register("mapcenterchanged",this.updateMapCenter,this);var i=new Image;i.src=OpenLayers.Util.getImagesLocation()+"cloud-popup-relative.png";return this};Ushahidi.Map.prototype.addLayer=function(e,t,n){var r=new OpenLayers.Format.GeoJSON;if(e==Ushahidi.KML)r=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:5});else if(e==Ushahidi.DEFAULT){this.deleteLayer("default");var i=null;t==undefined&&(t={});if(t.styleMap!=undefined){i=new OpenLayers.Layer.Vector("default",{styleMap:p});makers.addFeatures(new OpenLayers.Feature.Vector(this._olMap.getCenter()))}else{i=new OpenLayers.Layer.Markers("default");i.addMarker(new OpenLayers.Marker(this._olMap.getCenter()))}this._olMap.addLayer(i);if(t.detectMapClicks==undefined||t.detectMapClicks){var s=this;s._olMap.events.register("click",s._olMap,function(e){var t=s._olMap.getLonLatFromViewPortPx(e.xy);i.clearMarkers();i.addMarker(new OpenLayers.Marker(t));t.transform(Ushahidi.proj_900913,Ushahidi.proj_4326);var n={latitude:t.lat,longitude:t.lon};s.trigger("markerpositionchanged",n);var r=new OpenLayers.LonLat(n.longitude,n.latitude);r.transform(Ushahidi.proj_4326,Ushahidi.proj_900913);s._currentCenter=r})}this._isLoaded=1;return this}if(t==undefined)throw"Invalid layer options";n!==undefined&&n&&this._registry.push({layerType:e,options:t});preFeatureInsert=function(e){if(e.geometry){var t=new OpenLayers.Geometry.Point(e.geometry.x,e.geometry.y);OpenLayers.Projection.transform(t,Ushahidi.proj_4326,Ushahidi.proj_900913);e.geometry.x=t.x;e.geometry.y=t.y}};this.deleteLayer(t.name);var o={projection:Ushahidi.proj_4326,formatOptions:{extractStyles:!0,extractAttributes:!0}};t.transform&&(o.preFeatureInsert=preFeatureInsert);var u=Ushahidi.baseURL+t.url;if(e!==Ushahidi.KML){var a=[];for(var f in this._reportFilters)a.push(f+"="+this._reportFilters[f]);if(u.indexOf("?")!==-1){var l=u.indexOf("?"),c=u.substr(l+1,u.length).split("&");u=u.substring(0,l);for(var h=0;h<c.length;h++)a.push(c[h])}u+=a.length>0?"?"+a.join("&"):"";var p=null;if(t.styleMap!==undefined)p=t.styleMap;else{var d=Ushahidi.GeoJSONStyle();p=new OpenLayers.StyleMap({"default":d,select:d})}o.styleMap=p}var v=[];if(t.callback!==undefined)$.ajax({url:u,async:!1,success:function(e){var n=new OpenLayers.Format.JSON,r=n.write(t.callback(e)),i=new OpenLayers.Format.GeoJSON;v=i.read(r)},dataType:"json"});else{o.strategies=[new OpenLayers.Strategy.Fixed({preload:!0})];o.protocol=new OpenLayers.Protocol.HTTP({url:u,format:r})}var m=new OpenLayers.Layer.Vector(t.name,o);v!==null&&v.length>0&&m.addFeatures(v);var s=this;setTimeout(function(){s._olMap.addLayer(m)},1500);this._selectControl=new OpenLayers.Control.SelectFeature(m,{hover:this._selectOnHover,beforeSelect:this.closePopups,onSelect:this.onFeatureSelect,onUnselect:this.onFeatureUnselect,scope:this});this._olMap.addControl(this._selectControl);this._selectControl.activate();this._isLoaded=1;return this};Ushahidi.Map.prototype.updateReportFilters=function(e){if(e==undefined)throw"Missing filters";var t=!1,n=this;$.each(e,function(e,r){var i=n._reportFilters[e];if(i==undefined&&i==null||i!==r){t=!0;n._reportFilters[e]=r}});if(t){n.redraw();setTimeout(function(){n.trigger("filterschanged",n._reportFilters)},800)}};Ushahidi.Map.prototype.getReportFilters=function(){return this._reportFilters};Ushahidi.Map.prototype.refresh=function(e){if(this._isLoaded){this._reportFilters.z=this._olMap.getZoom();this.redraw()}return this};Ushahidi.Map.prototype.redraw=function(){this.closePopups();for(var e=0;e<this._registry.length;e++){var t=this._registry[e];this.addLayer(t.layerType,t.options)}return this};Ushahidi.Map.prototype.onFeatureSelect=function(e){this._selectedFeature=e;zoom_point=e.geometry.getBounds().getCenterLonLat();lon=zoom_point.lon;lat=zoom_point.lat;var t=null;if(e.attributes.thumb!==undefined&&e.attributes.thumb!=""){t=this.createDOMElement("div",{"class":"infowindow_image"});var n=this.createDOMElement("a",{href:e.attributes.link}),r=this.createDOMElement("img",{src:e.attributes.thumb});n.appendChild(r);t.appendChild(n)}else if(e.attributes.image!==undefined&&e.attributes.image!=""){t=this.createDOMElement("div",{"class":"infowindow_image"});var n=this.createDOMElement("a",{href:e.attributes.link,title:e.attributes.name}),r=this.createDOMElement("img",{src:e.attributes.image});n.appendChild(r);t.appendChild(n)}var i=this.createDOMElement("div",{"class":"infowindow"});t!==null&&i.appendChild(t);var s=this.createDOMElement("div",{"class":"infowindow_content"}),o=this.createDOMElement("div",{"class":"infowindow_list"});o.innerHTML=e.attributes.name;s.appendChild(o);var u=this.createDOMElement("div",{"class":"infowindow_meta"});if(e.attributes.link!==undefined&&e.attributes.link!=""){var n=this.createDOMElement("a",{href:e.attributes.link},"More Information");u.appendChild(n);u.appendChild(this.createDOMElement("br"))}var a=this.createDOMElement("a",{id:"zoomIn"},"Zoom In");u.appendChild(a);u.innerHTML+="&nbsp;&nbsp;|&nbsp;&nbsp;";var f=this.createDOMElement("a",{id:"zoomOut"},"Zoom Out");u.appendChild(f);s.appendChild(u);i.appendChild(s);i.appendChild(this.createDOMElement("div",{style:"clear: both;"}));var l=this.createDOMElement("div");l.appendChild(i.cloneNode(!0));l.innerHTML.search("<script")!==-1&&(l.innerHTML="Content contained Javascript! Escaped content below.<br />"+l.innerHTML.replace(/</g,"&lt;"));var c=new OpenLayers.Popup.FramedCloud("chicken",e.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(100,100),l.innerHTML,null,!0,this.onPopupClose);this._selectedFeature.popup=c;this._olMap.addPopup(c);c.show();this.registerPopup(c);$("#zoomIn",c.contentDiv).click({context:this,latitude:lat,longitude:lon,zoomFactor:1},this.zoomToSelectedFeature);$("#zoomOut",c.contentDiv).click({context:this,latitude:lat,longitude:lon,zoomFactor:-1},this.zoomToSelectedFeature)};Ushahidi.Map.prototype.createDOMElement=function(e,t,n){var r=document.createElement(e);if(t!==undefined)for(k in t)r.setAttribute(k,t[k]);n!==undefined&&n.length>0&&r.appendChild(document.createTextNode(n));return r};Ushahidi.Map.prototype.onFeatureUnselect=function(e){if(e.popup!=null){this._olMap.removePopup(e.popup);e.popup.destroy();e.popup=null}};Ushahidi.Map.prototype.onPopupClose=function(e){Ushahidi._currentMap.closePopups()};Ushahidi.Map.prototype.closePopups=function(){if(this._selectedFeature!==undefined&&this._selectedFeature!=null){this._selectControl.unselect(this._selectedFeature);this._selectedFeature=null}for(var e in this._popupRegistry){var t=this._popupRegistry[e];this._olMap.removePopup(t);$(t.contentDiv).fadeOut();try{t.destroy()}catch(n){}delete this._popupRegistry[e]}};Ushahidi.Map.prototype.zoomToSelectedFeature=function(e){var t=e.data,n=new OpenLayers.LonLat(t.longitude,t.latitude),r=t.zoomFactor+t.context._olMap.getZoom();t.context._olMap.setCenter(n,r);t.context.closePopups();return!1};Ushahidi.Map.prototype.register=function(e,t,n){if($.inArray(e,this._EVENTS)===-1)return;this._callbacks[e]==undefined&&(this._callbacks[e]=[]);this._callbacks[e].push({callback:t,context:n})};Ushahidi.Map.prototype.trigger=function(e,t){if(this._callbacks.length==0||this._callbacks[e]==undefined)return;var n=this._callbacks[e];for(var r=0;r<n.length;r++){var i=n[r];i.context==undefined||i.context==null?i.callback(t):i.callback.call(i.context,t)}};Ushahidi.Map.prototype.resize=function(){this._olMap.updateSize();this._olMap.pan(0,1)};Ushahidi.Map.prototype.deleteLayer=function(e){var t=this._olMap.getLayersByName(e);for(var n=0;n<t.length;n++){this._olMap.removeLayer(t[n]);t[n].destroyFeatures!==undefined&&t[n].destroyFeatures()}};Ushahidi.Map.prototype.addRadiusLayer=function(e){var t=this._olMap.getControlsByClass("OpenLayers.Control.LayerSwitcher");for(var n=0;n<t.length;n++)this._olMap.removeControl(t[n]);this.updateRadius(e);var r=this;this._olMap.events.register("click",r._olMap,function(e){var t=r._olMap.getLonLatFromViewPortPx(e.xy);t.transform(Ushahidi.proj_900913,Ushahidi.proj_4326);var n={latitude:t.lat,longitude:t.lon};r.updateRadius(n);r.trigger("markerpositionchanged",n)})};Ushahidi.Map.prototype.updateRadius=function(e){this._radius=e.radius==undefined?2e4:e.radius;e.latitude!==undefined&&e.longitude!==undefined&&(this._currentMarkerPosition={latitude:e.latitude,longitude:e.longitude});if(this._currentMarkerPosition.latitude==undefined||this._currentMarkerPosition.longitude==undefined)throw"Missing latitude and longitude in the options";var t=this._currentMarkerPosition.latitude,n=this._currentMarkerPosition.longitude;this.deleteLayer("radius");this.deleteLayer("radiusmarker");var r=new OpenLayers.LonLat(n,t);r.transform(Ushahidi.proj_4326,Ushahidi.proj_900913);this._olMap.moveTo(r);var i=new OpenLayers.Geometry.Point(n,t);i.transform(Ushahidi.proj_4326,Ushahidi.proj_900913);var s=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(i,this._radius,40,0),null,OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"])),o=new OpenLayers.Layer.Vector("radius");o.addFeatures([s]);var u=new OpenLayers.Layer.Markers("radiusmarker");u.addMarker(new OpenLayers.Marker(r));this._olMap.addLayers([o,u])};Ushahidi.Map.prototype.updateBaseLayer=function(e){var t=this._olMap.getLayersByName(e);if(t.length<1)throw"Layer "+e+" not found";t[0].setVisibility(!0);this._olMap.setBaseLayer(t[0])};Ushahidi.Map.prototype.updateZoom=function(e){if(this.currentZoom!==e){this.currentZoom=e;this._olMap.setCenter(this._currentCenter,e)}};Ushahidi.Map.prototype.updateMapCenter=function(e){var t=new OpenLayers.LonLat(e.longitude,e.latitude);t.transform(Ushahidi.proj_4326,Ushahidi.proj_900913);this._olMap.setCenter(t);this.addLayer(Ushahidi.DEFAULT);this.trigger("markerpositionchanged",e)};Ushahidi.Map.prototype.triggerZoomChanged=function(e){if(this._isLoaded){this.trigger("zoomchanged",this._olMap.getZoom());this.addLayer(Ushahidi.DEFAULT)}};Ushahidi.Map.prototype.registerPopup=function(e){this._popupRegistry[e.id]==undefined&&(this._popupRegistry[e.id]=e)}})();